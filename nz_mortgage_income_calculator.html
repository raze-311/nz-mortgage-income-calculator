<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NZ Mortgage + Income Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input { margin-top: 5px; }
    .chart-container { width: 400px; height: 400px; margin: 20px; display: inline-block; vertical-align: top; }
    .line-chart-container { width: 100%; height: 400px; margin: 20px 0; }
  </style>
</head>
<body>
  <h1>NZ Mortgage + Income Calculator</h1>

  <label>
    Gross Income (before tax):
    <input type="number" id="grossIncome" value="140000" />
  </label>
  <label>
    KiwiSaver %:
    <input type="number" id="kiwiSaver" value="3" />
  </label>
  <label>
    <input type="checkbox" id="hasStudentLoan" checked /> I have a student loan
  </label>
  <label id="studentLoanBalanceLabel">
    Student Loan Outstanding Balance:
    <input type="number" id="studentLoanBalance" value="33000" />
  </label>
  <label>
    Mortgage Value:
    <input type="number" id="mortgageValue" value="900000" />
  </label>
  <label>
    Mortgage Rate (%):
    <input type="number" id="mortgageRate" value="5" step="0.1" />
  </label>
  <label>
    Weekly Renter Income (optional):
    <input type="number" id="renterIncome" value="0" />
  </label>
  <label>
    <input type="checkbox" id="includeRenterIncome" /> Include renter income in gross income
  </label>
  <button onclick="calculate()">Calculate</button>

  <h2>Results</h2>
  <div id="results"></div>
  <div class="chart-container"><canvas id="incomeBreakdown"></canvas></div>
  <div id="mortgageCharts"></div>
  <div class="line-chart-container"><canvas id="mortgageBalanceLine"></canvas></div>

  <script>
    const accLevyRate = 0.0153; // 1.53%

    function calculateTax(income) {
      let tax = 0;
      const brackets = [
        { threshold: 14000, rate: 0.105 },
        { threshold: 48000, rate: 0.175 },
        { threshold: 70000, rate: 0.30 },
        { threshold: 180000, rate: 0.33 },
        { threshold: Infinity, rate: 0.39 }
      ];
      let last = 0;
      for (let b of brackets) {
        if (income > b.threshold) {
          tax += (b.threshold - last) * b.rate;
          last = b.threshold;
        } else {
          tax += (income - last) * b.rate;
          break;
        }
      }
      return tax;
    }

    function fmt(n) {
      return "$" + Number(n).toLocaleString();
    }

    function calculate() {
      const grossIncomeBase = parseFloat(document.getElementById('grossIncome').value);
      const kiwiSaverRate = parseFloat(document.getElementById('kiwiSaver').value) / 100;
      const hasStudentLoan = document.getElementById('hasStudentLoan').checked;
      const studentLoanBalance = hasStudentLoan ? parseFloat(document.getElementById('studentLoanBalance').value) : 0;
      const mortgageValue = parseFloat(document.getElementById('mortgageValue').value);
      const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) / 100;
      const renterIncome = parseFloat(document.getElementById('renterIncome').value) || 0;
      const includeRenter = document.getElementById('includeRenterIncome').checked;

      // Adjusted gross income
      const grossIncome = includeRenter ? grossIncomeBase + renterIncome * 52 : grossIncomeBase;

      // Income calculations
      const tax = calculateTax(grossIncome);
      const kiwiSaver = grossIncome * kiwiSaverRate;
      const accLevy = grossIncome * accLevyRate;
      const studentLoanThreshold = 24128;
      const studentLoanRepayment = hasStudentLoan ? Math.max(0, (grossIncome - studentLoanThreshold) * 0.12) : 0;
      const takeHome = grossIncome - tax - kiwiSaver - accLevy - studentLoanRepayment;
      const studentLoanYears = hasStudentLoan && studentLoanRepayment > 0 ? (studentLoanBalance / studentLoanRepayment).toFixed(1) : 'N/A';

      let resultsHtml = `<p>Income Tax: ${fmt(tax)}</p>`;
      resultsHtml += `<p>KiwiSaver: ${fmt(kiwiSaver)}</p>`;
      resultsHtml += `<p>ACC Levy: ${fmt(accLevy)}</p>`;
      if (hasStudentLoan) {
        resultsHtml += `<p>Annual Student Loan Repayment: ${fmt(studentLoanRepayment)}</p>`;
        resultsHtml += `<p>Time to repay Student Loan: ${studentLoanYears} years</p>`;
      }
      if (!includeRenter && renterIncome > 0) {
        resultsHtml += `<p>Additional Untaxed Renter Income: ${fmt(renterIncome * 52)}</p>`;
      }
      resultsHtml += `<p>Take Home Pay: ${fmt(takeHome)}</p>`;
      document.getElementById('results').innerHTML = resultsHtml;

      // Income breakdown chart
      const incomeCtx = document.getElementById('incomeBreakdown').getContext('2d');
      if (window.incomeChart) window.incomeChart.destroy();
      const pieLabels = ['Tax', 'KiwiSaver', 'ACC Levy', 'Student Loan', 'Take Home'];
      const pieData = [tax, kiwiSaver, accLevy, studentLoanRepayment, takeHome];
      if (!includeRenter && renterIncome > 0) {
        pieLabels.push('Renter Income');
        pieData.push(renterIncome * 52);
      }
      window.incomeChart = new Chart(incomeCtx, {
        type: 'pie',
        data: {
          labels: pieLabels,
          datasets: [{
            data: pieData,
            backgroundColor: ['#e74c3c','#3498db','#f1c40f','#9b59b6','#2ecc71','#95a5a6']
          }]
        }
      });

      // Mortgage calculations for 10, 20, 30 years
      document.getElementById('mortgageCharts').innerHTML = '';
      const lineDatasets = [];
      [10,20,30].forEach((years, idx) => {
        const months = years*12;
        const monthlyRate = mortgageRate/12;
        const monthlyPayment = mortgageValue*monthlyRate/(1-Math.pow(1+monthlyRate,-months));
        const weeklyPayment = monthlyPayment*12/52;
        const totalPaid = monthlyPayment*months;
        const totalInterest = totalPaid - mortgageValue;

        const baseIncomeWithSL = grossIncomeBase - calculateTax(grossIncomeBase) - (grossIncomeBase * kiwiSaverRate) - (grossIncomeBase * accLevyRate);
        const incomeWithSL = baseIncomeWithSL - (hasStudentLoan ? Math.max(0, (grossIncomeBase - studentLoanThreshold) * 0.12) : 0) + (!includeRenter ? renterIncome*52 : 0);
        const incomeWithoutSL = baseIncomeWithSL + (!includeRenter ? renterIncome*52 : 0);

        const percWithSL = (monthlyPayment*12 / incomeWithSL *100).toFixed(1);
        const percWithoutSL = (monthlyPayment*12 / incomeWithoutSL *100).toFixed(1);

        const div = document.createElement('div');
        div.className = 'chart-container';
        div.innerHTML = `<h3>${years}-Year Mortgage</h3>
          <p>Monthly Payment: ${fmt(monthlyPayment.toFixed(0))}</p>
          <p>Weekly Payment: ${fmt(weeklyPayment.toFixed(0))}</p>
          <p>Total Interest: ${fmt(totalInterest.toFixed(0))}</p>
          <p>Total Paid: ${fmt(totalPaid.toFixed(0))}</p>
          <p>% of Income (with SL): ${percWithSL}%</p>
          <p>% of Income (without SL): ${percWithoutSL}%</p>
          <canvas id='mortgagePie${years}'></canvas>`;
        document.getElementById('mortgageCharts').appendChild(div);

        // Pie chart: interest vs equity
        const pieCtx = document.getElementById(`mortgagePie${years}`).getContext('2d');
        new Chart(pieCtx, {
          type: 'pie',
          data: {
            labels: ['Interest','Equity'],
            datasets: [{
              data: [totalInterest, mortgageValue],
              backgroundColor: ['#e67e22','#2ecc71']
            }]
          }
        });

        // Line chart data: balance over time
        let balance = mortgageValue;
        const balances = [];
        for (let i=0;i<months;i++) {
          const interest = balance*monthlyRate;
          const principal = monthlyPayment - interest;
          balance -= principal;
          balances.push(balance>0?balance:0);
        }
        lineDatasets.push({
          label: `${years}-Year Term`,
          data: balances,
          borderColor: ['#3498db','#e74c3c','#2ecc71'][idx],
          fill:false
        });
      });

      // Combined line chart
      const lineCtx = document.getElementById('mortgageBalanceLine').getContext('2d');
      if (window.mortgageLineChart) window.mortgageLineChart.destroy();
      window.mortgageLineChart = new Chart(lineCtx, {
        type: 'line',
        data: {
          labels: Array.from({length:360},(_,i)=> (i+1)/12),
          datasets: lineDatasets
        },
        options: {
          scales: {
            x: {
              title: { display:true, text:'Years' },
              ticks: { callback: (val, idx) => idx % 12 === 0 ? (idx/12) : '' }
            },
            y: {
              title: { display:true, text:'Balance ($)' }
            }
          }
        }
      });
    }

    // toggle student loan balance visibility
    document.getElementById('hasStudentLoan').addEventListener('change', function() {
      document.getElementById('studentLoanBalanceLabel').style.display = this.checked ? 'block' : 'none';
    });
    document.getElementById('studentLoanBalanceLabel').style.display = document.getElementById('hasStudentLoan').checked ? 'block' : 'none';
  </script>
</body>
</html>

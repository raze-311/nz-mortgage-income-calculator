<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NZ Mortgage + Income Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    label { display: block; margin-top: 10px; }
    input { margin-top: 5px; }
    .chart-container { width: 400px; min-height: 600px; margin: 20px; display: inline-block; vertical-align: top; }
  </style>
</head>
<body>
  <h1>NZ Mortgage + Income Calculator</h1>

  <label>Gross Income (before tax): <input type="number" id="grossIncome" value="140000" /></label>
  <label>KiwiSaver %: <input type="number" id="kiwiSaver" value="3" /></label>
  <label><input type="checkbox" id="hasStudentLoan" checked /> I have a student loan</label>
  <label id="studentLoanBalanceLabel">Student Loan Outstanding Balance: <input type="number" id="studentLoanBalance" value="33000" /></label>
  <label>Deposit: <input type="number" id="deposit" value="200000" /></label>
  <label>Mortgage Value: <input type="number" id="mortgageValue" value="1300000" /></label>
  <label>Mortgage Rate (%): <input type="number" id="mortgageRate" value="5" step="0.1" /></label>
  <label>Weekly Renter Income (optional): <input type="number" id="renterIncome" value="0" /></label>
  <label><input type="checkbox" id="includeRenterIncome" /> Include renter income in gross income</label>

  <label>Mortgage Terms (years):<br>
    <input type="number" id="term1" value="10" />
    <input type="number" id="term2" value="20" />
    <input type="number" id="term3" value="30" />
  </label>

  <h3>Additional Costs</h3>
  <label>Rates: <input type="number" id="ratesCost" value="4000" />
    <select id="ratesPeriod">
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
      <option value="yearly" selected>Yearly</option>
    </select>
  </label>
  <label>Insurance: <input type="number" id="insuranceCost" value="3000" />
    <select id="insurancePeriod">
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
      <option value="yearly" selected>Yearly</option>
    </select>
  </label>
  <label>Maintenance: <input type="number" id="maintenanceCost" value="0" />
    <select id="maintenancePeriod">
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
      <option value="yearly" selected>Yearly</option>
    </select>
  </label>
  <label>Misc: <input type="number" id="miscCost" value="0" />
    <select id="miscPeriod">
      <option value="weekly">Weekly</option>
      <option value="monthly">Monthly</option>
      <option value="yearly" selected>Yearly</option>
    </select>
  </label>

  <h3>Growth Projections</h3>
  <label>Average House Increase Per Year (%): <input type="number" id="houseGrowthRate" value="6" step="0.1" /></label>
  <label>Capital Gains Tax Rate (%): <input type="number" id="capitalGainsTaxRate" value="0" step="0.1" /></label>

  <button onclick="calculate()">Calculate</button>

  <h2>Results</h2>
  <div id="results"></div>
  <div class="chart-container"><canvas id="incomeBreakdown"></canvas></div>
  <div id="mortgageCharts"></div>

  <script>
    const accLevyRate = 0.0153;

    function calculateTax(income) {
      let tax = 0;
      const brackets = [
        { threshold: 14000, rate: 0.105 },
        { threshold: 48000, rate: 0.175 },
        { threshold: 70000, rate: 0.30 },
        { threshold: 180000, rate: 0.33 },
        { threshold: Infinity, rate: 0.39 }
      ];
      let last = 0;
      for (let b of brackets) {
        if (income > b.threshold) {
          tax += (b.threshold - last) * b.rate;
          last = b.threshold;
        } else {
          tax += (income - last) * b.rate;
          break;
        }
      }
      return tax;
    }

    function fmt(n) {
      return "$" + Number(n).toLocaleString();
    }

    function amortisationSplit(principal, rate, periods) {
      const r = rate / 12;
      const payment = principal * r / (1 - Math.pow(1 + r, -periods));
      let balance = principal;
      let interestTotal = 0;
      let principalTotal = 0;

      for (let i = 0; i < periods; i++) {
        const interest = balance * r;
        const principalPaid = payment - interest;
        balance -= principalPaid;
        interestTotal += interest;
        principalTotal += principalPaid;
      }

      return { payment, interestTotal, principalTotal };
    }

    function calculate() {
      const grossIncomeBase = parseFloat(document.getElementById('grossIncome').value);
      const kiwiSaverRate = parseFloat(document.getElementById('kiwiSaver').value) / 100;
      const hasStudentLoan = document.getElementById('hasStudentLoan').checked;
      const studentLoanBalance = hasStudentLoan ? parseFloat(document.getElementById('studentLoanBalance').value) : 0;
      const deposit = parseFloat(document.getElementById('deposit').value);
      const mortgageValue = parseFloat(document.getElementById('mortgageValue').value);
      const houseValue = deposit + mortgageValue;
      const mortgageRate = parseFloat(document.getElementById('mortgageRate').value) / 100;
      const renterIncome = parseFloat(document.getElementById('renterIncome').value) || 0;
      const includeRenter = document.getElementById('includeRenterIncome').checked;

      // Convert additional costs to yearly
      function toYearly(cost, period) {
        if (period === 'weekly') return cost * 52;
        if (period === 'monthly') return cost * 12;
        return cost;
      }

      const ratesYearly = toYearly(parseFloat(document.getElementById('ratesCost').value) || 0, document.getElementById('ratesPeriod').value);
      const insuranceYearly = toYearly(parseFloat(document.getElementById('insuranceCost').value) || 0, document.getElementById('insurancePeriod').value);
      const maintenanceYearly = toYearly(parseFloat(document.getElementById('maintenanceCost').value) || 0, document.getElementById('maintenancePeriod').value);
      const miscYearly = toYearly(parseFloat(document.getElementById('miscCost').value) || 0, document.getElementById('miscPeriod').value);
      const totalAdditionalCostsYearly = ratesYearly + insuranceYearly + maintenanceYearly + miscYearly;

      const houseGrowthRate = parseFloat(document.getElementById('houseGrowthRate').value) / 100;
      const capitalGainsTaxRate = parseFloat(document.getElementById('capitalGainsTaxRate').value) / 100;

      const grossIncome = includeRenter ? grossIncomeBase + renterIncome * 52 : grossIncomeBase;
      const tax = calculateTax(grossIncome);
      const kiwiSaver = grossIncome * kiwiSaverRate;
      const accLevy = grossIncome * accLevyRate;
      const studentLoanThreshold = 24128;
      const studentLoanRepayment = hasStudentLoan ? Math.max(0, (grossIncome - studentLoanThreshold) * 0.12) : 0;
      const takeHome = grossIncome - tax - kiwiSaver - accLevy - studentLoanRepayment;

      let resultsHtml = `<p>Income Tax: ${fmt(tax)}</p>`;
      resultsHtml += `<p>KiwiSaver: ${fmt(kiwiSaver)}</p>`;
      resultsHtml += `<p>ACC Levy: ${fmt(accLevy)}</p>`;
      if (hasStudentLoan) {
        resultsHtml += `<p>Annual Student Loan Repayment: ${fmt(studentLoanRepayment)}</p>`;
      }
      if (!includeRenter && renterIncome > 0) {
        resultsHtml += `<p>Additional Untaxed Renter Income: ${fmt(renterIncome * 52)}</p>`;
      }
      resultsHtml += `<p>Take Home Pay: ${fmt(takeHome)}</p>`;
      document.getElementById('results').innerHTML = resultsHtml;

      const pieCtx = document.getElementById('incomeBreakdown').getContext('2d');
      if (window.incomeChart) window.incomeChart.destroy();
      const pieLabels = ['Tax','KiwiSaver','ACC Levy','Student Loan','Take Home'];
      const pieData = [tax, kiwiSaver, accLevy, studentLoanRepayment, takeHome];
      if (!includeRenter && renterIncome > 0) { pieLabels.push('Renter Income'); pieData.push(renterIncome * 52); }

      window.incomeChart = new Chart(pieCtx, {
        type: 'pie',
        data: { labels: pieLabels, datasets: [{ data: pieData }] }
      });

      document.getElementById('mortgageCharts').innerHTML = '';
      [parseInt(document.getElementById('term1').value), parseInt(document.getElementById('term2').value), parseInt(document.getElementById('term3').value)].forEach((years) => {
        const periods = years * 12;
        const { payment, interestTotal, principalTotal } = amortisationSplit(mortgageValue, mortgageRate, periods);

        const weekly = payment * 12 / 52;
        const yearly = payment * 12;

        const weeklyInterest = interestTotal / periods * 12 / 52;
        const monthlyInterest = interestTotal / periods;
        const yearlyInterest = interestTotal / years;

        const weeklyAdditionalCosts = totalAdditionalCostsYearly / 52;
        const monthlyAdditionalCosts = totalAdditionalCostsYearly / 12;

        const totalIncome = takeHome + renterIncome * 52;
        const totalCostsYearly = yearly + totalAdditionalCostsYearly;
        const expenditurePercent = (totalCostsYearly / totalIncome * 100).toFixed(1);
        const expenditureColor = expenditurePercent > 100 ? 'red' : 'black';

        const div = document.createElement('div');
        div.className = 'chart-container';
        div.innerHTML = `
          <h3>${years}-Year Mortgage</h3>
          <p style="color: ${expenditureColor}; font-weight: bold;">Expenditure Percent: ${expenditurePercent}%</p>
          <ul>
            <li><b>Weekly:</b>
              <ul>
                <li><b>Costs (${fmt((weekly + weeklyAdditionalCosts).toFixed(0))})</b>
                  <ul>
                    <li>Principal: ${fmt((weekly - weeklyInterest).toFixed(0))}</li>
                    <li>Interest: ${fmt(weeklyInterest.toFixed(0))}</li>
                    <li>Additional: ${fmt(weeklyAdditionalCosts.toFixed(0))}</li>
                  </ul>
                </li>
                <li><b>Income (${fmt(((takeHome + renterIncome * 52)/52).toFixed(0))})</b>
                  <ul>

                    <li>Deducted Salary: ${fmt((takeHome/52).toFixed(0))}</li>
                    <li>Renter: ${fmt(renterIncome)}</li>
                  </ul>
                </li>
              </ul>
            </li>

            <li><b>Monthly:</b>
              <ul>
                <li><b>Costs (${fmt((payment + monthlyAdditionalCosts).toFixed(0))})</b>
                  <ul>
                    <li>Principal: ${fmt((payment - monthlyInterest).toFixed(0))}</li>
                    <li>Interest: ${fmt(monthlyInterest.toFixed(0))}</li>
                    <li>Additional: ${fmt(monthlyAdditionalCosts.toFixed(0))}</li>
                  </ul>
                </li>
                <li><b>Income (${fmt(((takeHome + renterIncome * 52)/12).toFixed(0))})</b>
                  <ul>

                    <li>Deducted Salary: ${fmt((takeHome/12).toFixed(0))}</li>
                    <li>Renter: ${fmt((renterIncome*52/12).toFixed(0))}</li>
                  </ul>
                </li>
              </ul>
            </li>

            <li><b>Yearly:</b>
              <ul>
                <li><b>Costs (${fmt((yearly + totalAdditionalCostsYearly).toFixed(0))})</b>
                  <ul>
                    <li>Principal: ${fmt((yearly - yearlyInterest).toFixed(0))}</li>
                    <li>Interest: ${fmt(yearlyInterest.toFixed(0))}</li>
                    <li>Additional: ${fmt(totalAdditionalCostsYearly.toFixed(0))}</li>
                  </ul>
                </li>
                <li><b>Income (${fmt((takeHome + renterIncome * 52).toFixed(0))})</b>
                  <ul>

                    <li>Deducted Salary: ${fmt(takeHome.toFixed(0))}</li>
                    <li>Renter: ${fmt((renterIncome*52).toFixed(0))}</li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>

          <p>Total Interest: ${fmt(interestTotal.toFixed(0))}</p>
          <p>Total Paid: ${fmt((principalTotal + interestTotal).toFixed(0))}</p>

          <p><b>Projected Value Gain:</b></p>
          <ul>
            <li>Projected House Value: ${fmt((houseValue * Math.pow(1 + houseGrowthRate, years)).toFixed(0))}</li>
            <li>Total Net Profit: ${fmt((((houseValue * Math.pow(1 + houseGrowthRate, years)) - houseValue - interestTotal - (totalAdditionalCostsYearly * years)) * (1 - capitalGainsTaxRate)).toFixed(0))}</li>
            <li>Net Equity Gain Per Year: ${fmt((((houseValue * Math.pow(1 + houseGrowthRate, years)) - houseValue - interestTotal - (totalAdditionalCostsYearly * years)) / years).toFixed(0))}</li>
            <li>Annual Return Rate: ${(((Math.pow((houseValue * Math.pow(1 + houseGrowthRate, years)) / houseValue, 1/years) - 1) - (interestTotal / houseValue / years) - (totalAdditionalCostsYearly / houseValue)) * 100).toFixed(2)}%</li>
          </ul>

          <canvas id="mortgagePie${years}"></canvas>`;
        document.getElementById('mortgageCharts').appendChild(div);

        new Chart(document.getElementById(`mortgagePie${years}`).getContext('2d'), {
          type: 'pie',
          data: {
            labels: ['Interest','Principal'],
            datasets: [{ data: [interestTotal, principalTotal] }]
          }
        });
      });
    }

    document.getElementById('hasStudentLoan').addEventListener('change', function() {
      document.getElementById('studentLoanBalanceLabel').style.display = this.checked ? 'block' : 'none';
    });
    document.getElementById('studentLoanBalanceLabel').style.display = document.getElementById('hasStudentLoan').checked ? 'block' : 'none';
  </script>
</body>
</html>